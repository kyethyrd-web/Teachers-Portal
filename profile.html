<!DOCTYPE html>
<html>
<head>
  <title>Teacher Portal - Profile</title>
  <style>
    body { margin: 0; font-family: Arial; }
    .container { display: flex; }

    .sidebar {
      width: 220px;
      background: #f4f4f4;
      padding: 15px;
      height: 100vh;
    }

    .sidebar button {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      cursor: pointer;
    }

    .content {
      padding: 20px;
      flex: 1;
    }

    input {
      width: 100%;
      padding: 6px;
      margin-bottom: 10px;
    }

    h3 { margin-top: 30px; }

    #profilePic {
      width: 120px;
      height: 160px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ccc;
    }

    .disabled input {
      background: #f0f0f0;
    }
  </style>
</head>
<body>

<div class="container">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h3>Menu</h3>
    <button onclick="showProfile()">Profile</button>
    <button onclick="location.href='lesson-plan.html'">Lesson Plan</button>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- MAIN CONTENT -->
  <div class="content">

    <div id="profileSection">

      <h2>Profile Information</h2>

      <img id="profilePic" src="https://via.placeholder.com/120" alt="Profile Picture"><br><br>
      <input type="file" id="photoInput" accept="image/*">
      <button onclick="uploadPhoto()">Upload Photo</button>

      <h3>Personal Information</h3>
      <input id="name" placeholder="Full Name" disabled>
      <input id="email" placeholder="Email" disabled>
      <input id="school" placeholder="School" disabled>
      <input id="position" placeholder="Position" disabled>

      <h3>Government Information</h3>
      <input id="employeeId" placeholder="Employee ID" disabled>
      <input id="prcLicense" placeholder="PRC License No." disabled>
      <input id="depedEmail" placeholder="DepEd Email" disabled>
      <input id="district" placeholder="District" disabled>
      <input id="division" placeholder="Division" disabled>
      <input id="philhealth" placeholder="PhilHealth No." disabled>
      <input id="tin" placeholder="TIN No." disabled>
      <input id="gsis" placeholder="GSIS BP No." disabled>
      <input id="pagibig" placeholder="Pag-IBIG No." disabled>

      <button id="editBtn" onclick="enableEdit()">Edit</button>
      <button id="saveBtn" onclick="saveProfile()" style="display:none;">Save Profile</button>

      <p id="saveStatus"></p>
    </div>

  </div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDmb0oDlQVfEhcqx6OPgmWwump0b0R09xs",
  authDomain: "teachers-portal-98254.firebaseapp.com",
  projectId: "teachers-portal-98254",
  storageBucket: "teachers-portal-98254.firebasestorage.app",
  messagingSenderId: "479254583768",
  appId: "1:479254583768:web:b8dcf9da3a5616d5b37aad"
};
  
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;

onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    document.getElementById("email").value = user.email;
    loadProfile();
  } else {
    window.location.href = "login.html";
  }
});

async function loadProfile() {
  const docRef = doc(db, "users", currentUser.uid);
  const snap = await getDoc(docRef);

  if (snap.exists()) {
    const data = snap.data();

    document.getElementById("name").value = data.name || "";
    document.getElementById("school").value = data.school || "";
    document.getElementById("position").value = data.position || "";
    document.getElementById("employeeId").value = data.employeeId || "";
    document.getElementById("prcLicense").value = data.prcLicense || "";
    document.getElementById("depedEmail").value = data.depedEmail || "";
    document.getElementById("district").value = data.district || "";
    document.getElementById("division").value = data.division || "";
    document.getElementById("philhealth").value = data.philhealth || "";
    document.getElementById("tin").value = data.tin || "";
    document.getElementById("gsis").value = data.gsis || "";
    document.getElementById("pagibig").value = data.pagibig || "";
    document.getElementById("profilePic").src = data.photoURL || "https://via.placeholder.com/120";
  }
}

window.enableEdit = function() {
  const inputs = document.querySelectorAll("input");
  inputs.forEach(input => input.disabled = false);

  document.getElementById("editBtn").style.display = "none";
  document.getElementById("saveBtn").style.display = "block";
}

window.saveProfile = async function() {
  await setDoc(doc(db, "users", currentUser.uid), {
    name: document.getElementById("name").value,
    school: document.getElementById("school").value,
    position: document.getElementById("position").value,
    employeeId: document.getElementById("employeeId").value,
    prcLicense: document.getElementById("prcLicense").value,
    depedEmail: document.getElementById("depedEmail").value,
    district: document.getElementById("district").value,
    division: document.getElementById("division").value,
    philhealth: document.getElementById("philhealth").value,
    tin: document.getElementById("tin").value,
    gsis: document.getElementById("gsis").value,
    pagibig: document.getElementById("pagibig").value,
  }, { merge: true });

  document.getElementById("saveStatus").innerText = "Profile Saved Successfully!";

  // Gray out fields after save
  const inputs = document.querySelectorAll("input");
  inputs.forEach(input => input.disabled = true);

  document.getElementById("editBtn").style.display = "block";
  document.getElementById("saveBtn").style.display = "none";
}

window.uploadPhoto = async function() {
  const file = document.getElementById("photoInput").files[0];
  if (!file) return;

  const storageRef = ref(storage, `profilePics/${currentUser.uid}`);
  await uploadBytes(storageRef, file);

  const url = await getDownloadURL(storageRef);

  await setDoc(doc(db, "users", currentUser.uid), {
    photoURL: url
  }, { merge: true });

  document.getElementById("profilePic").src = url;
}

window.showProfile = function() {
  document.getElementById("profileSection").style.display = "block";
}

window.logout = function() {
  signOut(auth).then(() => {
    window.location.href = "login.html";
  });
}

</script>

</body>
</html>
